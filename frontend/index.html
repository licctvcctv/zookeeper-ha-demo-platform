<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZooKeeper 高可用演示控制台</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <style>
    body { padding: 1.5rem; }
    .tab-wrapper { display: flex; justify-content: center; margin: 1rem 0 1.5rem; }
    .tab-nav { display: inline-flex; background: rgba(40, 56, 72, 0.6); border: 1px solid #2f3b4a; border-radius: 999px; overflow: hidden; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35); }
    .tab-nav button { background: transparent; border: none; color: #d9e2ec; padding: 0.55rem 1.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; position: relative; }
    .tab-nav button + button { border-left: 1px solid rgba(61, 70, 84, 0.8); }
    .tab-nav button::after { content: ''; position: absolute; inset: 0; border-radius: 999px; opacity: 0; background: radial-gradient(circle at 50% 50%, rgba(38, 128, 194, 0.35), rgba(38, 128, 194, 0)); transition: opacity 0.2s ease; }
    .tab-nav button:hover::after { opacity: 1; }
    .tab-nav button.active { color: #fff; background: linear-gradient(135deg, #2680c2 0%, #1d8ad6 50%, #2680c2 100%); box-shadow: 0 8px 18px rgba(38, 128, 194, 0.4); }
    .tab-nav button.active::after { opacity: 0; }
    .node-card { border: 1px solid #3e4c59; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #0b1622; }
    .node-header { display: flex; justify-content: space-between; align-items: center; }
    pre.log-output { max-height: 240px; overflow-y: auto; background: #111; color: #0f0; padding: 1rem; border-radius: 6px; }
    .flex { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .flex > article { flex: 1 1 320px; }
    .actions button { margin-right: 0.5rem; }
    table tbody tr td { font-size: 0.9rem; }
    .badge { padding: 0.1rem 0.5rem; border-radius: 999px; font-size: 0.75rem; text-transform: capitalize; }
    .badge.leader { background: #0f7; color: #000; }
    .badge.follower { background: #09f; color: #fff; }
    .badge.down { background: #f33; color: #fff; }
    .muted { color: #9aa0ac; font-size: 0.85rem; margin: -0.25rem 0 0.75rem; }
    .control-panel { border: 1px solid #3e4c59; border-radius: 8px; padding: 1rem; background: #0b1622; margin-bottom: 1rem; }
    .control-panel button { margin-right: 0.5rem; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <main id="app">
    <header>
      <h1>ZooKeeper 高可用与负载均衡演示</h1>
      <p>展示三节点 ZooKeeper 集群的实时状态、运维操作和调度结果。默认不生成示例数据，可通过“负载与任务”页手动触发。</p>
    </header>

    <div class="tab-wrapper">
      <nav class="tab-nav" role="tablist">
        <button :class="{ active: currentTab === 'overview' }" @click="setTab('overview')">运行概览</button>
        <button :class="{ active: currentTab === 'workload' }" @click="setTab('workload')">负载与任务</button>
        <button :class="{ active: currentTab === 'logs' }" @click="setTab('logs')">日志与审计</button>
      </nav>
    </div>

    <section v-if="currentTab === 'overview'" aria-label="运行概览">
      <article>
        <h2>集群概览</h2>
        <p>当前 Leader：<strong>{{ overview.cluster.leader || '未知' }}</strong> ｜ 最近刷新：{{ lastUpdatedDisplay }}</p>
        <div class="flex">
          <article v-for="node in overview.cluster.nodes" :key="node.endpoint" class="node-card">
            <div class="node-header">
              <h3>{{ node.node || node.endpoint }}</h3>
              <span :class="['badge', stateClass(node.state)]">{{ node.state }}</span>
            </div>
            <ul>
              <li>连接数：{{ node.zk_num_alive_connections ?? 'N/A' }}</li>
              <li>平均延迟：{{ formatLatency(node) }}</li>
              <li>未处理请求：{{ node.zk_outstanding_requests ?? 'N/A' }}</li>
              <li>选举轮次：{{ node.zk_epoch ?? 'N/A' }}</li>
            </ul>
            <details>
              <summary>更多指标</summary>
              <pre style="max-height: 160px; overflow:auto;">{{ node }}</pre>
            </details>
            <footer class="actions">
              <button @click="triggerAction(node, 'start')" :disabled="actionLoading">启动</button>
              <button @click="triggerAction(node, 'stop')" :disabled="actionLoading">停用</button>
              <button @click="triggerAction(node, 'restart')" :disabled="actionLoading">重启</button>
              <button @click="loadLogs(node)" :disabled="actionLoading">查看日志</button>
            </footer>
          </article>
        </div>
      </article>
      <article>
        <h2>Grafana 监控面板</h2>
        <p>Grafana 默认账号 <code>admin/admin</code>（已开启匿名只读）。</p>
        <iframe src="http://localhost:3000/d/zk-demo-overview?orgId=1&refresh=10s&kiosk" width="100%" height="420" frameborder="0"></iframe>
      </article>
    </section>

    <section v-else-if="currentTab === 'workload'" aria-label="负载与任务">
      <article class="control-panel">
        <h2>手动触发示例流量</h2>
        <p class="muted">点击按钮即可生成示例文件、任务或节点事件，方便演示数据流。上传真实文件也会实时叠加。</p>
        <div>
          <button @click="triggerDemo({ files: 1 })" :disabled="demoLoading">生成示例文件</button>
          <button @click="triggerDemo({ tasks: 1 })" :disabled="demoLoading">推进任务状态</button>
          <button @click="triggerDemo({ znodes: 1 })" :disabled="demoLoading">制造 ZNode 事件</button>
        </div>
        <p v-if="demoMessage" class="muted" style="margin-top:0.75rem;">{{ demoMessage }}</p>
      </article>

      <article>
        <h2>文件分布</h2>
        <canvas id="distributionChart" height="200"></canvas>
        <form @submit.prevent="upload">
          <label>
            上传示例文件：
            <input type="file" ref="uploadInput" required />
          </label>
          <button type="submit" :disabled="uploading">{{ uploading ? '上传中…' : '上传并分配' }}</button>
        </form>
        <table role="grid">
          <thead>
            <tr>
              <th>ID</th>
              <th>文件名</th>
              <th>当前节点</th>
              <th>大小</th>
              <th>历史</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="file in files" :key="file.id">
              <td>{{ file.id }}</td>
              <td>{{ file.filename }}</td>
              <td>{{ file.node }}</td>
              <td>{{ formatBytes(file.size_bytes) }}</td>
              <td>
                <details>
                  <summary>查看</summary>
                  <ul>
                    <li v-for="history in file.history" :key="history.timestamp">
                      {{ history.timestamp }} - {{ history.action }} ({{ history.from || history.node }} → {{ history.to || history.node }})
                    </li>
                  </ul>
                </details>
              </td>
            </tr>
          </tbody>
        </table>
      </article>

      <article>
        <h2>任务流水</h2>
        <table role="grid">
          <thead>
            <tr>
              <th>任务 ID</th>
              <th>节点</th>
              <th>状态</th>
              <th>更新时间</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="task in tasks" :key="task.task_id">
              <td>{{ task.task_id }}</td>
              <td>{{ task.node }}</td>
              <td>{{ task.status }}</td>
              <td>{{ task.updated_at }}</td>
              <td>{{ task.details }}</td>
            </tr>
          </tbody>
        </table>
      </article>
    </section>

    <section v-else aria-label="日志与审计">
      <article>
        <h2>集中日志（Filebeat → Elasticsearch）</h2>
        <form @submit.prevent="searchLogs" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.75rem;">
          <input type="text" v-model="logQuery" placeholder="关键字或 Lucene 查询" style="flex:1 1 220px;" />
          <select v-model="logService" style="flex:0 0 160px;">
            <option value="">全部服务</option>
            <option value="zookeeper">zookeeper</option>
            <option value="backend">backend</option>
            <option value="operations">operations</option>
          </select>
          <button type="submit">查询</button>
        </form>
        <table role="grid">
          <thead>
            <tr>
              <th>时间</th>
              <th>服务</th>
              <th>主机</th>
              <th>内容</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="logsLoading">
              <td colspan="4">加载中…</td>
            </tr>
            <tr v-for="log in logs" :key="log.timestamp + (log.message || '')">
              <td>{{ log.timestamp }}</td>
              <td>{{ log.service }}</td>
              <td>{{ log.host || log.container_id }}</td>
              <td style="max-width:480px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" :title="log.message">{{ log.message }}</td>
            </tr>
            <tr v-if="!logsLoading && !logs.length">
              <td colspan="4">暂无日志数据，尝试触发一次操作或调整查询条件。</td>
            </tr>
          </tbody>
        </table>
      </article>

      <article>
        <h2>操作审计</h2>
        <table role="grid">
          <thead>
            <tr>
              <th>时间</th>
              <th>操作</th>
              <th>节点</th>
              <th>结果</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="op in operations" :key="op.id">
              <td>{{ op.timestamp }}</td>
              <td>{{ op.action }}</td>
              <td>{{ op.node }}</td>
              <td>{{ op.status }}</td>
              <td>{{ op.details }}</td>
            </tr>
          </tbody>
        </table>
      </article>

      <article>
        <h2>节点实时日志</h2>
        <p v-if="!logsText">点击上方“运行概览”中的节点卡片查看实时日志。</p>
        <pre class="log-output" v-if="logsText">{{ logsText }}</pre>
      </article>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>
    const API_BASE = '/api';

    const app = Vue.createApp({
      data() {
        return {
          currentTab: 'overview',
          overview: { cluster: { nodes: [], leader: null } },
          files: [],
          tasks: [],
          operations: [],
          logs: [],
          logsText: '',
          logQuery: '',
          logService: '',
          logsLoading: false,
          uploading: false,
          actionLoading: false,
          demoLoading: false,
          demoMessage: '',
          chart: null,
          lastUpdated: null,
        };
      },
      computed: {
        lastUpdatedDisplay() {
          return this.lastUpdated ? new Date(this.lastUpdated).toLocaleString() : '未知';
        }
      },
      methods: {
        setTab(tab) {
          this.currentTab = tab;
        },
        async refreshAll() {
          await Promise.all([this.loadOverview(), this.loadOperations()]);
          this.drawChart();
        },
        async loadOverview() {
          const res = await fetch(`${API_BASE}/overview`);
          if (!res.ok) {
            console.error('加载 overview 失败');
            return;
          }
          const data = await res.json();
          this.overview = data;
          this.lastUpdated = Date.now();
          this.files = (data.files || []).map(file => ({
            ...file,
            history: typeof file.history === 'string' ? JSON.parse(file.history) : (file.history || [])
          }));
          this.tasks = data.tasks || [];
        },
        async loadOperations() {
          const res = await fetch(`${API_BASE}/operations?limit=50`);
          if (res.ok) {
            this.operations = await res.json();
          }
        },
        stateClass(state) {
          if (!state) return 'badge down';
          const lowered = state.toLowerCase();
          if (lowered.includes('leader')) return 'badge leader';
          if (lowered.includes('follower')) return 'badge follower';
          return 'badge down';
        },
        formatLatency(node) {
          const latency = node.zk_avg_latency_ms || node.zk_avg_request_latency_ms || node.zk_avg_latency;
          return latency !== undefined ? `${latency} ms` : 'N/A';
        },
        formatBytes(bytes) {
          if (!bytes) return '0 B';
          const units = ['B', 'KB', 'MB', 'GB'];
          let idx = 0;
          let value = bytes;
          while (value >= 1024 && idx < units.length - 1) {
            value /= 1024;
            idx += 1;
          }
          return `${value.toFixed(1)} ${units[idx]}`;
        },
        async triggerAction(node, action) {
          this.actionLoading = true;
          try {
            const res = await fetch(`${API_BASE}/nodes/${node.node || node.endpoint.split(':')[0]}/${action}`, { method: 'POST' });
            if (!res.ok) {
              const err = await res.json();
              alert(`操作失败: ${err.detail || res.status}`);
            }
          } catch (err) {
            alert(`操作异常: ${err}`);
          } finally {
            this.actionLoading = false;
            this.refreshAll();
          }
        },
        async loadLogs(node) {
          const nodeId = node.node || node.endpoint.split(':')[0];
          const res = await fetch(`${API_BASE}/logs/zookeeper/${nodeId}?tail=200`);
          if (res.ok) {
            const data = await res.json();
            this.logsText = `# ${nodeId} 最新日志\n\n${data.logs}`;
          }
        },
        async searchLogs() {
          this.logsLoading = true;
          try {
            const params = new URLSearchParams();
            if (this.logQuery) params.append('query', this.logQuery);
            if (this.logService) params.append('service', this.logService);
            params.append('size', '50');
            const res = await fetch(`${API_BASE}/logs/search?${params.toString()}`);
            if (res.ok) {
              this.logs = await res.json();
            }
          } finally {
            this.logsLoading = false;
          }
        },
        async triggerDemo(payload) {
          this.demoLoading = true;
          try {
            const res = await fetch(`${API_BASE}/demo/actions`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              this.demoMessage = `触发失败: ${err.detail || res.status}`;
              return;
            }
            const data = await res.json();
            const parts = [];
            if (data.files) parts.push(`文件 × ${data.files}`);
            if ((data.taskMessages || []).length) parts.push(`任务事件 × ${data.taskMessages.length}`);
            if ((data.znodePaths || []).length) parts.push(`ZNode 事件 × ${data.znodePaths.length}`);
            this.demoMessage = parts.length ? `完成：${parts.join('，')}` : '没有新的示例数据，请检查配额或参数。';
          } catch (err) {
            this.demoMessage = `触发异常: ${err}`;
          } finally {
            this.demoLoading = false;
            this.refreshAll();
            this.searchLogs();
          }
        },
        async upload() {
          if (!this.$refs.uploadInput.files.length) return;
          const file = this.$refs.uploadInput.files[0];
          const form = new FormData();
          form.append('file', file);
          this.uploading = true;
          try {
            const res = await fetch(`${API_BASE}/files/upload`, { method: 'POST', body: form });
            if (res.ok) {
              const data = await res.json();
              alert(`上传成功，分配到 ${data.node}`);
              this.$refs.uploadInput.value = '';
            } else {
              alert('上传失败');
            }
          } finally {
            this.uploading = false;
            this.refreshAll();
            this.searchLogs();
          }
        },
        drawChart() {
          const counts = {};
          for (const file of this.files) {
            counts[file.node] = (counts[file.node] || 0) + 1;
          }
          const knownNodes = (this.overview.cluster?.nodes || []).map(node => node.node || (node.endpoint ? node.endpoint.split(':')[0] : '未知'));
          for (const name of knownNodes) {
            if (!(name in counts)) counts[name] = 0;
          }
          const labels = Object.keys(counts);
          const data = Object.values(counts);
          const ctx = document.getElementById('distributionChart');
          if (!this.chart) {
            this.chart = new Chart(ctx, {
              type: 'bar',
              data: { labels, datasets: [{ label: '文件数量', data, backgroundColor: '#0a84ff' }] },
              options: { scales: { y: { beginAtZero: true, precision: 0 } } }
            });
          } else {
            this.chart.data.labels = labels;
            this.chart.data.datasets[0].data = data;
            this.chart.update();
          }
        }
      },
      mounted() {
        this.refreshAll();
        this.searchLogs();
        setInterval(() => this.refreshAll(), 5000);
        setInterval(() => this.searchLogs(), 10000);
      }
    });

    app.mount('#app');
  </script>
</body>
</html>
