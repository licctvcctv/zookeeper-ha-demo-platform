# 实时负载可视化功能说明

## 新增功能概览

本次优化为前端添加了完整的实时负载可视化功能，让任务调度过程更加直观和易于监控。

## 1. 运行概览页面 (overview.html)

### 新增图表
1. **系统状态概览卡片**
   - 总任务数
   - 运行中任务数
   - 已完成任务数
   
2. **任务分布图（饼图）**
   - 按节点显示任务分布
   - 使用不同颜色区分各个节点
   - 实时更新，每5秒刷新一次
   
3. **文件分布图（柱状图）**
   - 显示各节点的文件数量
   - 直观展示负载是否均衡
   - 实时更新

### 特性
- 自动检测无数据状态并显示友好提示
- 响应式设计，适配不同屏幕尺寸
- 使用 Chart.js 进行图表渲染
- 5秒自动刷新间隔

## 2. 负载与任务页面 (workload.html)

### 新增图表
1. **任务状态分布图（饼图）**
   - 排队中任务（蓝色）
   - 运行中任务（黄色）
   - 已成功任务（绿色）
   - 已失败任务（红色）
   
2. **节点任务分布图（柱状图）**
   - 显示每个节点上的任务数量
   - 帮助识别任务分配是否均衡

3. **实时负载监控卡片**
   - 调度阈值：显示触发调度的文件数差异值
   - 当前差异：实时显示当前最大文件数差异，超过阈值时显示警告色
   - 文件总数：显示系统中的总文件数和节点数

### 特性
- 8秒自动刷新间隔
- 动态颜色编码（差异过大时变为警告色）
- 与操作历史时间线配合，提供完整的调度追踪

## 3. 技术实现细节

### Chart.js 集成
- 使用 Chart.js 4.4.3
- 支持饼图、柱状图、圆环图等多种图表类型
- 自定义工具提示和图例

### 数据流
```
后端 API (/api/overview, /api/scheduler/diagnostics)
  ↓
Vue 组件 data
  ↓
computed 属性计算统计数据
  ↓
updateCharts() 方法更新图表
  ↓
Chart.js 渲染可视化
```

### 自动刷新机制
- overview.html: 每5秒刷新
- workload.html: 每8秒刷新
- 刷新时自动更新所有图表

## 4. 使用方法

### 查看实时负载
1. 启动系统：
   ```bash
   docker-compose up -d
   cd backend && uvicorn app.main:app --host 0.0.0.0 --port 8080
   ```

2. 访问页面：
   - http://localhost:8080/ui/overview.html - 查看整体概览
   - http://localhost:8080/ui/workload.html - 查看详细任务和负载

### 创建负载观察图表变化

#### 方法一：使用批量上传功能
1. 在 workload.html 页面找到"批量上传演示"区域
2. 设置参数：
   - 模式：选择"集中到指定节点"
   - 目标节点：选择 zk1
   - 文件数量：20
   - 单个大小：128 KB
   - 勾选"上传后立即调度"
3. 点击"批量上传"
4. 观察图表实时变化：
   - 文件分布图会显示 zk1 负载增加
   - 调度后文件会被迁移到其他节点
   - 任务状态图显示任务执行过程

#### 方法二：使用热点制造功能
1. 在 workload.html 页面找到"热点制造"区域
2. 设置参数：
   - 目标节点：zk2
   - 文件数量：15
   - 单个大小：256 KB
   - 勾选"生成后立即调度"
3. 点击"生成热点文件"
4. 观察：
   - 节点负载卡片显示 zk2 负载突增
   - 调度器自动执行迁移
   - 操作历史时间线记录全过程

#### 方法三：手动上传并调度
1. 在"文件分布与上传"区域上传单个文件
2. 重复上传多次到同一节点
3. 当差异超过阈值（默认3），点击"手动执行调度"
4. 观察图表实时更新

## 5. 监控指标说明

### 调度阈值
- 默认值：3
- 含义：当任意两个节点的文件数差异 ≥ 3 时，触发调度
- 可在 backend/app/config.py 中配置 `SCHEDULER_THRESHOLD`

### 当前差异
- 实时计算最大和最小节点的文件数差异
- 颜色编码：
  - 绿色：差异 < 阈值（平衡状态）
  - 橙色：差异 ≥ 阈值（需要调度）

### 任务统计
- **总任务数**：系统中所有任务（包括完成、失败、运行中等）
- **成功率**：已成功任务 / (已成功 + 已失败) * 100%
- **运行中任务**：当前正在执行的任务数量

## 6. 图表交互

### 鼠标悬停
- 将鼠标悬停在图表的任意部分
- 显示详细的数值信息
- 例如：节点名称、任务/文件数量

### 图例点击
- 点击图例可以显示/隐藏对应的数据系列
- 有助于聚焦特定节点或状态

## 7. 性能优化

- 图表使用 Canvas 渲染，性能优秀
- 只在数据变化时更新图表，避免不必要的重绘
- 空数据时显示遮罩层，不渲染图表内容

## 8. 故障排除

### 图表不显示
- 检查浏览器控制台是否有 JavaScript 错误
- 确认 Chart.js CDN 可访问
- 刷新页面重新加载

### 数据不更新
- 检查后端服务是否正常运行
- 查看网络请求是否成功（开发者工具 Network 标签）
- 确认定时刷新器是否启动（检查控制台）

### 图表显示异常
- 清除浏览器缓存
- 使用硬刷新（Ctrl+Shift+R 或 Cmd+Shift+R）
- 确保使用现代浏览器（Chrome 90+, Firefox 88+, Safari 14+）

## 9. 下一步扩展

可以考虑添加的功能：
1. **历史趋势图**：显示过去一段时间的负载变化曲线
2. **告警阈值可视化**：在图表上标注阈值线
3. **节点健康度评分**：综合多个指标计算健康度
4. **调度效率统计**：展示调度器的执行次数和效果
5. **实时动画**：文件迁移时的动画效果
6. **导出报告**：将统计数据导出为 PDF 或 Excel

## 10. 演示建议

为了最佳的演示效果，建议按以下步骤操作：

1. 先访问 overview.html，展示系统整体状态
2. 在 workload.html 中创建热点（选择 zk1，生成20个文件）
3. 返回 overview.html，观察负载图表变化
4. 在 workload.html 中点击"手动执行调度"
5. 观察调度快照和操作历史时间线
6. 查看任务状态图表的变化
7. 等待几秒钟，让系统自动生成更多演示数据
8. 再次查看各个图表，展示实时更新效果

这样可以完整地展示系统的负载创建、检测、调度和可视化功能。
