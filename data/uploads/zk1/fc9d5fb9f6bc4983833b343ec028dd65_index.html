<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZooKeeper 高可用演示控制台</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <style>
    body { padding: 1.5rem; }
    .node-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .node-header { display: flex; justify-content: space-between; align-items: center; }
    pre.log-output { max-height: 240px; overflow-y: auto; background: #111; color: #0f0; padding: 1rem; border-radius: 6px; }
    .flex { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .flex > article { flex: 1 1 320px; }
    .actions button { margin-right: 0.5rem; }
    table tbody tr td { font-size: 0.9rem; }
    .badge { padding: 0.1rem 0.5rem; border-radius: 999px; font-size: 0.75rem; }
    .badge.leader { background: #0f7; color: #000; }
    .badge.follower { background: #09f; color: #fff; }
    .badge.down { background: #f33; color: #fff; }
    .muted { color: #9aa0ac; font-size: 0.85rem; margin: -0.25rem 0 0.75rem; }
  </style>
</head>
<body>
  <main id="app">
    <header>
      <h1>ZooKeeper 高可用与负载均衡演示</h1>
      <p>展示三节点 ZooKeeper 集群的实时状态、运维操作和自动调度效果。页面数据每 5 秒刷新一次。</p>
    </header>

    <section aria-label="集群状态">
      <article>
        <h2>集群概览</h2>
        <p>当前 Leader：<strong>{{ overview.cluster.leader || '未知' }}</strong> ｜ 最近刷新：{{ lastUpdatedDisplay }}</p>
        <div class="flex">
          <article v-for="node in overview.cluster.nodes" :key="node.endpoint" class="node-card">
            <div class="node-header">
              <h3>{{ node.node || node.endpoint }}</h3>
              <span :class="['badge', stateClass(node.state)]">{{ node.state }}</span>
            </div>
            <ul>
              <li>连接数：{{ node.zk_num_alive_connections ?? 'N/A' }}</li>
              <li>平均延迟：{{ formatLatency(node) }}</li>
              <li>未处理请求：{{ node.zk_outstanding_requests ?? 'N/A' }}</li>
              <li>选举轮次：{{ node.zk_epoch ?? 'N/A' }}</li>
            </ul>
            <details>
              <summary>更多指标</summary>
              <pre style="max-height: 160px; overflow:auto;">{{ node }}</pre>
            </details>
            <footer class="actions">
              <button @click="triggerAction(node, 'start')" :disabled="actionLoading">启动</button>
              <button @click="triggerAction(node, 'stop')" :disabled="actionLoading">停用</button>
              <button @click="triggerAction(node, 'restart')" :disabled="actionLoading">重启</button>
              <button @click="loadLogs(node)" :disabled="actionLoading">查看日志</button>
            </footer>
          </article>
        </div>
      </article>
    </section>

    <section aria-label="Grafana 面板">
      <article>
        <h2>Grafana 监控面板</h2>
        <p>Grafana 默认账号 <code>admin/admin</code>。如需嵌入仪表盘，请在 Grafana 中开启匿名访问或更新权限。</p>
        <iframe src="http://localhost:3000/d/zk-demo-overview?orgId=1&refresh=10s&kiosk" width="100%" height="420" frameborder="0"></iframe>
      </article>
    </section>

    <section class="flex" aria-label="文件与负载">
      <article>
        <h2>文件分布 · 实时演示</h2>
        <p class="muted">页面默认会加载内置示例流量，你上传的真实文件会叠加显示；若需要纯手动演示，可在 `DEMO_WORKLOAD_ENABLED` 关闭。</p>
        <canvas id="distributionChart" height="200"></canvas>
        <form @submit.prevent="upload">
          <label>
            上传示例文件：
            <input type="file" ref="uploadInput" required />
          </label>
          <button type="submit" :disabled="uploading">{{ uploading ? '上传中…' : '上传并分配' }}</button>
        </form>
        <table role="grid">
          <thead>
            <tr>
              <th>ID</th>
              <th>文件名</th>
              <th>当前节点</th>
              <th>大小</th>
              <th>历史</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="file in files" :key="file.id">
              <td>{{ file.id }}</td>
              <td>{{ file.filename }}</td>
              <td>{{ file.node }}</td>
              <td>{{ formatBytes(file.size_bytes) }}</td>
              <td>
                <details>
                  <summary>查看</summary>
                  <ul>
                    <li v-for="history in file.history" :key="history.timestamp">
                      {{ history.timestamp }} - {{ history.action }} ({{ history.from || history.node }} → {{ history.to || history.node }})
                    </li>
                  </ul>
                </details>
              </td>
            </tr>
          </tbody>
        </table>
      </article>

      <article>
        <h2>操作审计</h2>
        <table role="grid">
          <thead>
            <tr>
              <th>时间</th>
              <th>操作</th>
              <th>节点</th>
              <th>结果</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="op in operations" :key="op.id">
              <td>{{ op.timestamp }}</td>
              <td>{{ op.action }}</td>
              <td>{{ op.node }}</td>
              <td>{{ op.status }}</td>
              <td>{{ op.details }}</td>
            </tr>
          </tbody>
        </table>
      </article>
    </section>

    <section class="flex" aria-label="任务与日志">
      <article>
        <h2>应用任务流水</h2>
        <p class="muted">示例 workload 会自动创建/执行任务，用于展示调度流程。真实环境可替换为业务任务表。</p>
        <table role="grid">
          <thead>
            <tr>
              <th>任务 ID</th>
              <th>节点</th>
              <th>状态</th>
              <th>更新时间</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="task in tasks" :key="task.task_id">
              <td>{{ task.task_id }}</td>
              <td>{{ task.node }}</td>
              <td>{{ task.status }}</td>
              <td>{{ task.updated_at }}</td>
              <td>{{ task.details }}</td>
            </tr>
          </tbody>
        </table>
      </article>
      <article>
        <h2>集中日志（Filebeat → Elasticsearch）</h2>
        <form @submit.prevent="searchLogs" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.75rem;">
          <input type="text" v-model="logQuery" placeholder="关键字或 Lucene 查询" style="flex:1 1 220px;" />
          <select v-model="logService" style="flex:0 0 160px;">
            <option value="">全部服务</option>
            <option value="zookeeper">zookeeper</option>
            <option value="backend">backend</option>
          </select>
          <button type="submit">查询</button>
        </form>
        <table role="grid">
          <thead>
            <tr>
              <th>时间</th>
              <th>服务</th>
              <th>主机</th>
              <th>内容</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="logsLoading">
              <td colspan="4">加载中…</td>
            </tr>
            <tr v-for="log in logs" :key="log.timestamp + log.message">
              <td>{{ log.timestamp }}</td>
              <td>{{ log.service }}</td>
              <td>{{ log.host || log.container_id }}</td>
              <td style="max-width:440px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" :title="log.message">{{ log.message }}</td>
            </tr>
            <tr v-if="!logsLoading && !logs.length">
              <td colspan="4">暂无日志数据，等待 Filebeat 收集或调整查询条件。</td>
            </tr>
          </tbody>
        </table>
      </article>
    </section>

    <section aria-label="节点日志">
      <article>
        <h2>节点实时日志</h2>
        <p v-if="!logsText">点击节点卡片上的“查看日志”加载最新日志。</p>
        <pre class="log-output" v-if="logsText">{{ logsText }}</pre>
      </article>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>
    const API_BASE = '/api';

    const app = Vue.createApp({
      data() {
        return {
          overview: { cluster: { nodes: [], leader: null } },
          files: [],
          tasks: [],
          operations: [],
          logsText: '',
          logs: [],
          logQuery: '',
          logService: '',
          logsLoading: false,
          uploading: false,
          actionLoading: false,
          chart: null,
          lastUpdated: null,
        };
      },
      computed: {
        lastUpdatedDisplay() {
          return this.lastUpdated ? new Date(this.lastUpdated).toLocaleString() : '未知';
        }
      },
      methods: {
        async refreshAll() {
          await Promise.all([this.loadOverview(), this.loadOperations()]);
          this.drawChart();
        },
        async loadOverview() {
          const res = await fetch(`${API_BASE}/overview`);
          if (!res.ok) {
            console.error('加载 overview 失败');
            return;
          }
          const data = await res.json();
          this.overview = data;
          this.lastUpdated = Date.now();
          this.files = (data.files || []).map(file => ({
            ...file,
            history: typeof file.history === 'string' ? JSON.parse(file.history) : (file.history || [])
          }));
          this.tasks = data.tasks || [];
        },
        async loadOperations() {
          const res = await fetch(`${API_BASE}/operations?limit=50`);
          if (res.ok) {
            this.operations = await res.json();
          }
        },
        stateClass(state) {
          if (!state) return 'badge down';
          const lowered = state.toLowerCase();
          if (lowered.includes('leader')) return 'badge leader';
          if (lowered.includes('follower')) return 'badge follower';
          return 'badge down';
        },
        formatLatency(node) {
          const latency = node.zk_avg_latency_ms || node.zk_avg_request_latency_ms || node.zk_avg_latency;
          return latency !== undefined ? `${latency} ms` : 'N/A';
        },
        formatBytes(bytes) {
          if (!bytes) return '0 B';
          const units = ['B', 'KB', 'MB', 'GB'];
          let idx = 0;
          let value = bytes;
          while (value >= 1024 && idx < units.length - 1) {
            value /= 1024;
            idx += 1;
          }
          return `${value.toFixed(1)} ${units[idx]}`;
        },
        async triggerAction(node, action) {
          this.actionLoading = true;
          try {
            const res = await fetch(`${API_BASE}/nodes/${node.node || node.endpoint.split(':')[0]}/${action}`, { method: 'POST' });
            if (!res.ok) {
              const err = await res.json();
              alert(`操作失败: ${err.detail || res.status}`);
            }
          } catch (err) {
            alert(`操作异常: ${err}`);
          } finally {
            this.actionLoading = false;
            this.refreshAll();
          }
        },
        async loadLogs(node) {
          const nodeId = node.node || node.endpoint.split(':')[0];
          const res = await fetch(`${API_BASE}/logs/zookeeper/${nodeId}?tail=200`);
          if (res.ok) {
            const data = await res.json();
            this.logsText = `# ${nodeId} 最新日志\n\n${data.logs}`;
          }
        },
        async searchLogs() {
          this.logsLoading = true;
          try {
            const params = new URLSearchParams();
            if (this.logQuery) params.append('query', this.logQuery);
            if (this.logService) params.append('service', this.logService);
            params.append('size', '50');
            const res = await fetch(`${API_BASE}/logs/search?${params.toString()}`);
            if (res.ok) {
              this.logs = await res.json();
            }
          } finally {
            this.logsLoading = false;
          }
        },
        async upload() {
          if (!this.$refs.uploadInput.files.length) return;
          const file = this.$refs.uploadInput.files[0];
          const form = new FormData();
          form.append('file', file);
          this.uploading = true;
          try {
            const res = await fetch(`${API_BASE}/files/upload`, { method: 'POST', body: form });
            if (res.ok) {
              const data = await res.json();
              alert(`上传成功，分配到 ${data.node}`);
              this.$refs.uploadInput.value = '';
            } else {
              alert('上传失败');
            }
          } finally {
            this.uploading = false;
            this.refreshAll();
          }
        },
        drawChart() {
          const counts = {};
          for (const file of this.files) {
            counts[file.node] = (counts[file.node] || 0) + 1;
          }
          const knownNodes = (this.overview.cluster?.nodes || []).map(node => node.node || (node.endpoint ? node.endpoint.split(':')[0] : '未知'));
          for (const name of knownNodes) {
            if (!(name in counts)) counts[name] = 0;
          }
          const labels = Object.keys(counts);
          const data = Object.values(counts);
          const ctx = document.getElementById('distributionChart');
          if (!this.chart) {
            this.chart = new Chart(ctx, {
              type: 'bar',
              data: { labels, datasets: [{ label: '文件数量', data, backgroundColor: '#0a84ff' }] },
              options: { scales: { y: { beginAtZero: true, precision: 0 } } }
            });
          } else {
            this.chart.data.labels = labels;
            this.chart.data.datasets[0].data = data;
            this.chart.update();
          }
        }
      },
      mounted() {
        this.refreshAll();
        this.searchLogs();
        setInterval(() => this.refreshAll(), 5000);
        setInterval(() => this.searchLogs(), 10000);
      }
    });

    app.mount('#app');
  </script>
</body>
</html>
